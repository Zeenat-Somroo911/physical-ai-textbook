"use strict";(globalThis.webpackChunkphysical_ai_textbook=globalThis.webpackChunkphysical_ai_textbook||[]).push([[6738],{8095:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"module-04-vla/action-planning","title":"Chapter 4: Action Planning","description":"Introduction","source":"@site/docs/module-04-vla/04-action-planning.md","sourceDirName":"module-04-vla","slug":"/module-04-vla/action-planning","permalink":"/physical-ai-textbook/docs/module-04-vla/action-planning","draft":false,"unlisted":false,"editUrl":"https://github.com/Zeenat-Somroo911/physical-ai-textbook/edit/main/docs/module-04-vla/04-action-planning.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Chapter 3: LLM Integration","permalink":"/physical-ai-textbook/docs/module-04-vla/llm-integration"},"next":{"title":"Chapter 5: Multimodal Systems","permalink":"/physical-ai-textbook/docs/module-04-vla/multimodal"}}');var a=r(4848),i=r(8453);const s={sidebar_position:4},o="Chapter 4: Action Planning",l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Why Action Planning?",id:"why-action-planning",level:3},{value:"Task Planning",id:"task-planning",level:2},{value:"Hierarchical Task Decomposition",id:"hierarchical-task-decomposition",level:3},{value:"Planning with LLM",id:"planning-with-llm",level:3},{value:"Breaking Commands into Steps",id:"breaking-commands-into-steps",level:2},{value:"Step-by-Step Decomposition",id:"step-by-step-decomposition",level:3},{value:"Action Primitives",id:"action-primitives",level:2},{value:"Defining Primitives",id:"defining-primitives",level:3},{value:"State Machines",id:"state-machines",level:2},{value:"Basic State Machine",id:"basic-state-machine",level:3},{value:"Complete Planner",id:"complete-planner",level:2},{value:"Integrated Planning System",id:"integrated-planning-system",level:3},{value:"ROS 2 Integration",id:"ros-2-integration",level:2},{value:"Planning Service",id:"planning-service",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Common Errors and Solutions",id:"common-errors-and-solutions",level:2},{value:"Error 1: &quot;Invalid plan format&quot;",id:"error-1-invalid-plan-format",level:3},{value:"Error 2: &quot;Action execution failed&quot;",id:"error-2-action-execution-failed",level:3},{value:"Next Steps",id:"next-steps",level:2}];function p(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"chapter-4-action-planning",children:"Chapter 4: Action Planning"})}),"\n",(0,a.jsx)(e.h2,{id:"introduction",children:"Introduction"}),"\n",(0,a.jsx)(e.p,{children:"Action planning is the process of breaking down high-level natural language commands into sequences of executable robot actions. This chapter covers task decomposition, action primitives, state machines, and complete planning systems."}),"\n",(0,a.jsx)(e.h3,{id:"why-action-planning",children:"Why Action Planning?"}),"\n",(0,a.jsx)(e.p,{children:"Natural language commands are often complex and need to be broken down:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:'"Pick up the cup and bring it to me"'})," \u2192 Multiple steps"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:'"Navigate to the kitchen and check if the door is open"'})," \u2192 Sequential tasks"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:'"Clean the room"'})," \u2192 Complex multi-step process"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"task-planning",children:"Task Planning"}),"\n",(0,a.jsx)(e.h3,{id:"hierarchical-task-decomposition",children:"Hierarchical Task Decomposition"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-mermaid",children:"graph TB\r\n    A[High-Level Command] --\x3e B[Task Decomposition]\r\n    B --\x3e C[Sub-task 1]\r\n    B --\x3e D[Sub-task 2]\r\n    B --\x3e E[Sub-task 3]\r\n    \r\n    C --\x3e C1[Action 1]\r\n    C --\x3e C2[Action 2]\r\n    \r\n    D --\x3e D1[Action 3]\r\n    D --\x3e D2[Action 4]\r\n    \r\n    E --\x3e E1[Action 5]\r\n    \r\n    style A fill:#e1f5ff\r\n    style B fill:#c8e6c9\r\n    style C1 fill:#fff9c4\n"})}),"\n",(0,a.jsx)(e.h3,{id:"planning-with-llm",children:"Planning with LLM"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\r\n"""\r\nTask Planner\r\n\r\nBreaks down complex commands into action sequences.\r\n"""\r\n\r\nimport openai\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom std_msgs.msg import String\r\nimport json\r\n\r\nclass TaskPlanner(Node):\r\n    def __init__(self):\r\n        super().__init__(\'task_planner\')\r\n        \r\n        openai.api_key = os.getenv(\'OPENAI_API_KEY\')\r\n        \r\n        # Subscriber\r\n        self.command_sub = self.create_subscription(\r\n            String,\r\n            \'/voice_command\',\r\n            self.command_callback,\r\n            10\r\n        )\r\n        \r\n        # Publisher\r\n        self.plan_pub = self.create_publisher(String, \'/action_plan\', 10)\r\n        \r\n        self.get_logger().info(\'Task planner started\')\r\n    \r\n    def command_callback(self, msg):\r\n        """Plan task from command."""\r\n        command = msg.data\r\n        self.get_logger().info(f\'Planning: {command}\')\r\n        \r\n        # Generate plan\r\n        plan = self.generate_plan(command)\r\n        \r\n        if plan:\r\n            # Publish plan\r\n            plan_msg = String()\r\n            plan_msg.data = json.dumps(plan)\r\n            self.plan_pub.publish(plan_msg)\r\n            \r\n            # Execute plan\r\n            self.execute_plan(plan)\r\n    \r\n    def generate_plan(self, command):\r\n        """Generate action plan using LLM."""\r\n        prompt = f"""Break down this robot command into a sequence of actions.\r\n\r\nCommand: "{command}"\r\n\r\nAvailable actions:\r\n- navigate_to(location)\r\n- pick_up(object)\r\n- place(object, location)\r\n- open(door)\r\n- close(door)\r\n- check(object)\r\n- wait(duration)\r\n\r\nRespond with JSON array of actions:\r\n[\r\n    {{"action": "navigate_to", "parameters": {{"location": "kitchen"}}}},\r\n    {{"action": "pick_up", "parameters": {{"object": "cup"}}}},\r\n    {{"action": "navigate_to", "parameters": {{"location": "user"}}}},\r\n    {{"action": "place", "parameters": {{"object": "cup", "location": "user"}}}}\r\n]\r\n\r\nExample:\r\nCommand: "Pick up the cup and bring it to me"\r\nPlan: [\r\n    {{"action": "navigate_to", "parameters": {{"location": "cup_location"}}}},\r\n    {{"action": "pick_up", "parameters": {{"object": "cup"}}}},\r\n    {{"action": "navigate_to", "parameters": {{"location": "user"}}}},\r\n    {{"action": "place", "parameters": {{"object": "cup", "location": "user"}}}}\r\n]\r\n\r\nNow plan: "{command}"\r\n"""\r\n        \r\n        try:\r\n            response = openai.ChatCompletion.create(\r\n                model="gpt-3.5-turbo",\r\n                messages=[\r\n                    {"role": "system", "content": "You are a robot task planner. Always respond with valid JSON arrays."},\r\n                    {"role": "user", "content": prompt}\r\n                ],\r\n                temperature=0.3,\r\n                max_tokens=500\r\n            )\r\n            \r\n            text = response.choices[0].message.content.strip()\r\n            \r\n            # Extract JSON\r\n            if \'```\' in text:\r\n                text = text.split(\'```\')[1]\r\n                if text.startswith(\'json\'):\r\n                    text = text[4:]\r\n            \r\n            plan = json.loads(text)\r\n            return plan\r\n        \r\n        except Exception as e:\r\n            self.get_logger().error(f\'Planning error: {e}\')\r\n            return None\r\n    \r\n    def execute_plan(self, plan):\r\n        """Execute action plan."""\r\n        for i, action in enumerate(plan):\r\n            self.get_logger().info(f\'Step {i+1}/{len(plan)}: {action["action"]}\')\r\n            self.execute_action(action)\r\n            \r\n            # Wait for action to complete\r\n            # (Implementation depends on your robot)\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    node = TaskPlanner()\r\n    \r\n    try:\r\n        rclpy.spin(node)\r\n    except KeyboardInterrupt:\r\n        node.get_logger().info(\'Shutting down...\')\r\n    finally:\r\n        node.destroy_node()\r\n        rclpy.shutdown()\r\n\r\nif __name__ == \'__main__\':\r\n    main()\n'})}),"\n",(0,a.jsx)(e.h2,{id:"breaking-commands-into-steps",children:"Breaking Commands into Steps"}),"\n",(0,a.jsx)(e.h3,{id:"step-by-step-decomposition",children:"Step-by-Step Decomposition"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:"class CommandDecomposer:\r\n    \"\"\"Decomposes commands into executable steps.\"\"\"\r\n    \r\n    def __init__(self):\r\n        self.action_primitives = {\r\n            'move': ['navigate', 'drive', 'go'],\r\n            'pick': ['pick', 'grab', 'take'],\r\n            'place': ['place', 'put', 'set'],\r\n            'turn': ['turn', 'rotate'],\r\n            'stop': ['stop', 'halt', 'wait']\r\n        }\r\n    \r\n    def decompose(self, command):\r\n        \"\"\"Break command into steps.\"\"\"\r\n        # Use LLM for complex decomposition\r\n        steps = self.llm_decompose(command)\r\n        return steps\r\n    \r\n    def llm_decompose(self, command):\r\n        \"\"\"Use LLM to decompose command.\"\"\"\r\n        prompt = f\"\"\"Break this command into steps: \"{command}\"\r\n\r\nEach step should be a single, executable action.\r\nReturn as JSON array of strings.\"\"\"\r\n        \r\n        # Call LLM and parse response\r\n        # (Implementation similar to previous examples)\r\n        pass\n"})}),"\n",(0,a.jsx)(e.h2,{id:"action-primitives",children:"Action Primitives"}),"\n",(0,a.jsx)(e.h3,{id:"defining-primitives",children:"Defining Primitives"}),"\n",(0,a.jsx)(e.p,{children:"Action primitives are the basic building blocks of robot behavior."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:"#!/usr/bin/env python3\r\n\"\"\"\r\nAction Primitives\r\n\r\nBasic robot actions that can be combined.\r\n\"\"\"\r\n\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom geometry_msgs.msg import Twist, PoseStamped\r\nfrom std_msgs.msg import String\r\nimport math\r\n\r\nclass ActionPrimitives(Node):\r\n    def __init__(self):\r\n        super().__init__('action_primitives')\r\n        \r\n        # Publishers\r\n        self.cmd_vel_pub = self.create_publisher(Twist, '/cmd_vel', 10)\r\n        self.goal_pub = self.create_publisher(PoseStamped, '/goal_pose', 10)\r\n        self.status_pub = self.create_publisher(String, '/action_status', 10)\r\n        \r\n        # Action registry\r\n        self.actions = {\r\n            'move_forward': self.move_forward,\r\n            'move_backward': self.move_backward,\r\n            'turn_left': self.turn_left,\r\n            'turn_right': self.turn_right,\r\n            'stop': self.stop,\r\n            'navigate_to': self.navigate_to,\r\n            'pick_up': self.pick_up,\r\n            'place': self.place_object\r\n        }\r\n        \r\n        self.get_logger().info('Action primitives ready')\r\n    \r\n    def execute_primitive(self, action_name, parameters):\r\n        \"\"\"Execute an action primitive.\"\"\"\r\n        if action_name in self.actions:\r\n            return self.actions[action_name](parameters)\r\n        else:\r\n            self.get_logger().error(f'Unknown action: {action_name}')\r\n            return False\r\n    \r\n    def move_forward(self, params):\r\n        \"\"\"Move forward primitive.\"\"\"\r\n        distance = params.get('distance', 1.0)\r\n        speed = params.get('speed', 0.5)\r\n        \r\n        cmd = Twist()\r\n        cmd.linear.x = speed\r\n        \r\n        # Publish for specified duration\r\n        duration = distance / speed\r\n        # (In real implementation, use timer or action)\r\n        \r\n        self.cmd_vel_pub.publish(cmd)\r\n        self.get_logger().info(f'Moving forward {distance}m')\r\n        return True\r\n    \r\n    def move_backward(self, params):\r\n        \"\"\"Move backward primitive.\"\"\"\r\n        distance = params.get('distance', 1.0)\r\n        speed = params.get('speed', 0.5)\r\n        \r\n        cmd = Twist()\r\n        cmd.linear.x = -speed\r\n        self.cmd_vel_pub.publish(cmd)\r\n        \r\n        self.get_logger().info(f'Moving backward {distance}m')\r\n        return True\r\n    \r\n    def turn_left(self, params):\r\n        \"\"\"Turn left primitive.\"\"\"\r\n        angle = params.get('angle', 90)\r\n        \r\n        cmd = Twist()\r\n        cmd.angular.z = 0.5\r\n        \r\n        # Calculate duration based on angle\r\n        # (Simplified, real implementation needs odometry)\r\n        \r\n        self.cmd_vel_pub.publish(cmd)\r\n        self.get_logger().info(f'Turning left {angle} degrees')\r\n        return True\r\n    \r\n    def turn_right(self, params):\r\n        \"\"\"Turn right primitive.\"\"\"\r\n        angle = params.get('angle', 90)\r\n        \r\n        cmd = Twist()\r\n        cmd.angular.z = -0.5\r\n        self.cmd_vel_pub.publish(cmd)\r\n        \r\n        self.get_logger().info(f'Turning right {angle} degrees')\r\n        return True\r\n    \r\n    def stop(self, params):\r\n        \"\"\"Stop primitive.\"\"\"\r\n        cmd = Twist()\r\n        self.cmd_vel_pub.publish(cmd)\r\n        \r\n        self.get_logger().info('Stopping')\r\n        return True\r\n    \r\n    def navigate_to(self, params):\r\n        \"\"\"Navigate to location primitive.\"\"\"\r\n        x = params.get('x', 0.0)\r\n        y = params.get('y', 0.0)\r\n        theta = params.get('theta', 0.0)\r\n        \r\n        goal = PoseStamped()\r\n        goal.header.frame_id = 'map'\r\n        goal.pose.position.x = x\r\n        goal.pose.position.y = y\r\n        goal.pose.orientation.z = math.sin(theta / 2.0)\r\n        goal.pose.orientation.w = math.cos(theta / 2.0)\r\n        \r\n        self.goal_pub.publish(goal)\r\n        self.get_logger().info(f'Navigating to ({x}, {y})')\r\n        return True\r\n    \r\n    def pick_up(self, params):\r\n        \"\"\"Pick up object primitive.\"\"\"\r\n        object_name = params.get('object', 'unknown')\r\n        \r\n        # Implementation depends on robot\r\n        # This is a placeholder\r\n        self.get_logger().info(f'Picking up {object_name}')\r\n        return True\r\n    \r\n    def place_object(self, params):\r\n        \"\"\"Place object primitive.\"\"\"\r\n        object_name = params.get('object', 'unknown')\r\n        location = params.get('location', 'unknown')\r\n        \r\n        self.get_logger().info(f'Placing {object_name} at {location}')\r\n        return True\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    node = ActionPrimitives()\r\n    \r\n    # Example usage\r\n    node.execute_primitive('move_forward', {'distance': 2.0})\r\n    \r\n    try:\r\n        rclpy.spin(node)\r\n    except KeyboardInterrupt:\r\n        node.get_logger().info('Shutting down...')\r\n    finally:\r\n        node.destroy_node()\r\n        rclpy.shutdown()\r\n\r\nif __name__ == '__main__':\r\n    main()\n"})}),"\n",(0,a.jsx)(e.h2,{id:"state-machines",children:"State Machines"}),"\n",(0,a.jsx)(e.p,{children:"State machines provide structured control flow for robot behaviors."}),"\n",(0,a.jsx)(e.h3,{id:"basic-state-machine",children:"Basic State Machine"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\r\n"""\r\nRobot State Machine\r\n\r\nManages robot states and transitions.\r\n"""\r\n\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom enum import Enum\r\nfrom std_msgs.msg import String\r\n\r\nclass RobotState(Enum):\r\n    IDLE = \'idle\'\r\n    PLANNING = \'planning\'\r\n    EXECUTING = \'executing\'\r\n    WAITING = \'waiting\'\r\n    ERROR = \'error\'\r\n\r\nclass RobotStateMachine(Node):\r\n    def __init__(self):\r\n        super().__init__(\'robot_state_machine\')\r\n        \r\n        # State\r\n        self.current_state = RobotState.IDLE\r\n        self.current_plan = []\r\n        self.current_action_index = 0\r\n        \r\n        # Subscribers\r\n        self.command_sub = self.create_subscription(\r\n            String, \'/voice_command\', self.command_callback, 10\r\n        )\r\n        self.status_sub = self.create_subscription(\r\n            String, \'/action_status\', self.status_callback, 10\r\n        )\r\n        \r\n        # Publishers\r\n        self.state_pub = self.create_publisher(String, \'/robot_state\', 10)\r\n        self.action_pub = self.create_publisher(String, \'/execute_action\', 10)\r\n        \r\n        # Timer for state machine\r\n        self.timer = self.create_timer(0.1, self.state_machine_step)\r\n        \r\n        self.get_logger().info(\'State machine started\')\r\n    \r\n    def command_callback(self, msg):\r\n        """Handle new command."""\r\n        if self.current_state == RobotState.IDLE:\r\n            self.transition_to(RobotState.PLANNING)\r\n            self.plan_task(msg.data)\r\n    \r\n    def status_callback(self, msg):\r\n        """Handle action status updates."""\r\n        status = msg.data\r\n        \r\n        if status == \'completed\' and self.current_state == RobotState.EXECUTING:\r\n            self.current_action_index += 1\r\n            \r\n            if self.current_action_index >= len(self.current_plan):\r\n                # Plan complete\r\n                self.transition_to(RobotState.IDLE)\r\n            else:\r\n                # Execute next action\r\n                self.execute_next_action()\r\n        \r\n        elif status == \'failed\':\r\n            self.transition_to(RobotState.ERROR)\r\n    \r\n    def transition_to(self, new_state):\r\n        """Transition to new state."""\r\n        old_state = self.current_state\r\n        self.current_state = new_state\r\n        \r\n        self.get_logger().info(f\'State: {old_state.value} -> {new_state.value}\')\r\n        \r\n        # Publish state\r\n        state_msg = String()\r\n        state_msg.data = new_state.value\r\n        self.state_pub.publish(state_msg)\r\n    \r\n    def plan_task(self, command):\r\n        """Plan task from command."""\r\n        # Generate plan (using LLM or other method)\r\n        # self.current_plan = generate_plan(command)\r\n        \r\n        if self.current_plan:\r\n            self.transition_to(RobotState.EXECUTING)\r\n            self.current_action_index = 0\r\n            self.execute_next_action()\r\n        else:\r\n            self.transition_to(RobotState.ERROR)\r\n    \r\n    def execute_next_action(self):\r\n        """Execute next action in plan."""\r\n        if self.current_action_index < len(self.current_plan):\r\n            action = self.current_plan[self.current_action_index]\r\n            \r\n            action_msg = String()\r\n            action_msg.data = json.dumps(action)\r\n            self.action_pub.publish(action_msg)\r\n            \r\n            self.get_logger().info(\r\n                f\'Executing action {self.current_action_index + 1}/{len(self.current_plan)}: \'\r\n                f\'{action["action"]}\'\r\n            )\r\n    \r\n    def state_machine_step(self):\r\n        """State machine update loop."""\r\n        # Handle state-specific logic\r\n        if self.current_state == RobotState.ERROR:\r\n            # Error recovery\r\n            self.recover_from_error()\r\n    \r\n    def recover_from_error(self):\r\n        """Recover from error state."""\r\n        # Implement error recovery\r\n        self.get_logger().warn(\'Recovering from error\')\r\n        self.transition_to(RobotState.IDLE)\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    node = RobotStateMachine()\r\n    \r\n    try:\r\n        rclpy.spin(node)\r\n    except KeyboardInterrupt:\r\n        node.get_logger().info(\'Shutting down...\')\r\n    finally:\r\n        node.destroy_node()\r\n        rclpy.shutdown()\r\n\r\nif __name__ == \'__main__\':\r\n    main()\n'})}),"\n",(0,a.jsx)(e.h2,{id:"complete-planner",children:"Complete Planner"}),"\n",(0,a.jsx)(e.h3,{id:"integrated-planning-system",children:"Integrated Planning System"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\r\n"""\r\nComplete Action Planner\r\n\r\nIntegrates LLM planning with state machine and primitives.\r\n"""\r\n\r\nimport openai\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom std_msgs.msg import String\r\nfrom geometry_msgs.msg import Twist\r\nimport json\r\nfrom enum import Enum\r\n\r\nclass PlannerState(Enum):\r\n    IDLE = \'idle\'\r\n    PLANNING = \'planning\'\r\n    EXECUTING = \'executing\'\r\n    COMPLETED = \'completed\'\r\n    FAILED = \'failed\'\r\n\r\nclass CompletePlanner(Node):\r\n    def __init__(self):\r\n        super().__init__(\'complete_planner\')\r\n        \r\n        openai.api_key = os.getenv(\'OPENAI_API_KEY\')\r\n        \r\n        # State\r\n        self.state = PlannerState.IDLE\r\n        self.current_plan = []\r\n        self.current_step = 0\r\n        \r\n        # Subscribers\r\n        self.command_sub = self.create_subscription(\r\n            String, \'/voice_command\', self.command_callback, 10\r\n        )\r\n        \r\n        # Publishers\r\n        self.plan_pub = self.create_publisher(String, \'/action_plan\', 10)\r\n        self.action_pub = self.create_publisher(String, \'/execute_action\', 10)\r\n        self.cmd_vel_pub = self.create_publisher(Twist, \'/cmd_vel\', 10)\r\n        \r\n        # Timer\r\n        self.timer = self.create_timer(0.1, self.planner_loop)\r\n        \r\n        self.get_logger().info(\'Complete planner started\')\r\n    \r\n    def command_callback(self, msg):\r\n        """Handle new command."""\r\n        if self.state == PlannerState.IDLE:\r\n            command = msg.data\r\n            self.get_logger().info(f\'New command: {command}\')\r\n            self.plan_command(command)\r\n    \r\n    def plan_command(self, command):\r\n        """Generate plan from command."""\r\n        self.state = PlannerState.PLANNING\r\n        \r\n        # Use LLM to generate plan\r\n        plan = self.generate_plan_with_llm(command)\r\n        \r\n        if plan and len(plan) > 0:\r\n            self.current_plan = plan\r\n            self.current_step = 0\r\n            self.state = PlannerState.EXECUTING\r\n            \r\n            # Publish plan\r\n            plan_msg = String()\r\n            plan_msg.data = json.dumps(plan)\r\n            self.plan_pub.publish(plan_msg)\r\n            \r\n            self.get_logger().info(f\'Plan generated: {len(plan)} steps\')\r\n        else:\r\n            self.state = PlannerState.FAILED\r\n            self.get_logger().error(\'Failed to generate plan\')\r\n    \r\n    def generate_plan_with_llm(self, command):\r\n        """Generate plan using LLM."""\r\n        prompt = f"""Create an action plan for this robot command: "{command}"\r\n\r\nAvailable actions:\r\n- move_forward(distance)\r\n- move_backward(distance)\r\n- turn_left(angle)\r\n- turn_right(angle)\r\n- navigate_to(x, y, theta)\r\n- pick_up(object)\r\n- place(object, location)\r\n- stop()\r\n\r\nReturn JSON array:\r\n[\r\n    {{"action": "action_name", "parameters": {{"param": "value"}}}},\r\n    ...\r\n]"""\r\n        \r\n        try:\r\n            response = openai.ChatCompletion.create(\r\n                model="gpt-3.5-turbo",\r\n                messages=[\r\n                    {"role": "system", "content": "You are a robot planner. Return valid JSON arrays."},\r\n                    {"role": "user", "content": prompt}\r\n                ],\r\n                temperature=0.3,\r\n                max_tokens=500\r\n            )\r\n            \r\n            text = response.choices[0].message.content.strip()\r\n            \r\n            # Extract JSON\r\n            if \'```\' in text:\r\n                text = text.split(\'```\')[1]\r\n                if text.startswith(\'json\'):\r\n                    text = text[4:]\r\n            \r\n            return json.loads(text)\r\n        \r\n        except Exception as e:\r\n            self.get_logger().error(f\'LLM planning error: {e}\')\r\n            return None\r\n    \r\n    def planner_loop(self):\r\n        """Main planner loop."""\r\n        if self.state == PlannerState.EXECUTING:\r\n            if self.current_step < len(self.current_plan):\r\n                action = self.current_plan[self.current_step]\r\n                self.execute_action(action)\r\n            else:\r\n                # Plan complete\r\n                self.state = PlannerState.COMPLETED\r\n                self.get_logger().info(\'Plan completed\')\r\n                self.state = PlannerState.IDLE\r\n    \r\n    def execute_action(self, action):\r\n        """Execute a single action."""\r\n        action_name = action.get(\'action\')\r\n        params = action.get(\'parameters\', {})\r\n        \r\n        self.get_logger().info(f\'Executing: {action_name} with {params}\')\r\n        \r\n        # Execute based on action type\r\n        success = False\r\n        \r\n        if action_name == \'move_forward\':\r\n            success = self.move_forward(params)\r\n        elif action_name == \'move_backward\':\r\n            success = self.move_backward(params)\r\n        elif action_name == \'turn_left\':\r\n            success = self.turn_left(params)\r\n        elif action_name == \'turn_right\':\r\n            success = self.turn_right(params)\r\n        elif action_name == \'stop\':\r\n            success = self.stop()\r\n        elif action_name == \'navigate_to\':\r\n            success = self.navigate_to(params)\r\n        else:\r\n            self.get_logger().warn(f\'Unknown action: {action_name}\')\r\n        \r\n        if success:\r\n            # Move to next step\r\n            self.current_step += 1\r\n        else:\r\n            # Retry or fail\r\n            self.get_logger().warn(f\'Action failed: {action_name}\')\r\n    \r\n    def move_forward(self, params):\r\n        """Execute move forward."""\r\n        cmd = Twist()\r\n        cmd.linear.x = 0.5\r\n        self.cmd_vel_pub.publish(cmd)\r\n        return True\r\n    \r\n    def move_backward(self, params):\r\n        """Execute move backward."""\r\n        cmd = Twist()\r\n        cmd.linear.x = -0.5\r\n        self.cmd_vel_pub.publish(cmd)\r\n        return True\r\n    \r\n    def turn_left(self, params):\r\n        """Execute turn left."""\r\n        cmd = Twist()\r\n        cmd.angular.z = 0.5\r\n        self.cmd_vel_pub.publish(cmd)\r\n        return True\r\n    \r\n    def turn_right(self, params):\r\n        """Execute turn right."""\r\n        cmd = Twist()\r\n        cmd.angular.z = -0.5\r\n        self.cmd_vel_pub.publish(cmd)\r\n        return True\r\n    \r\n    def stop(self):\r\n        """Execute stop."""\r\n        cmd = Twist()\r\n        self.cmd_vel_pub.publish(cmd)\r\n        return True\r\n    \r\n    def navigate_to(self, params):\r\n        """Execute navigate to."""\r\n        # Use Nav2 or custom navigation\r\n        # (Implementation depends on your setup)\r\n        return True\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    node = CompletePlanner()\r\n    \r\n    try:\r\n        rclpy.spin(node)\r\n    except KeyboardInterrupt:\r\n        node.get_logger().info(\'Shutting down...\')\r\n    finally:\r\n        node.destroy_node()\r\n        rclpy.shutdown()\r\n\r\nif __name__ == \'__main__\':\r\n    main()\n'})}),"\n",(0,a.jsx)(e.h2,{id:"ros-2-integration",children:"ROS 2 Integration"}),"\n",(0,a.jsx)(e.h3,{id:"planning-service",children:"Planning Service"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:'from example_interfaces.srv import String\r\n\r\nclass PlanningService(Node):\r\n    def __init__(self):\r\n        super().__init__(\'planning_service\')\r\n        \r\n        self.service = self.create_service(\r\n            String,\r\n            \'plan_command\',\r\n            self.plan_callback\r\n        )\r\n    \r\n    def plan_callback(self, request, response):\r\n        """Service callback for planning."""\r\n        command = request.data\r\n        \r\n        # Generate plan\r\n        plan = self.generate_plan(command)\r\n        \r\n        response.data = json.dumps(plan)\r\n        return response\n'})}),"\n",(0,a.jsx)(e.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Validate Plans"}),": Always check plan validity before execution"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Error Handling"}),": Handle plan generation failures"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"State Management"}),": Use state machines for complex behaviors"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Modular Actions"}),": Keep action primitives simple and reusable"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Feedback"}),": Provide status updates during execution"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"common-errors-and-solutions",children:"Common Errors and Solutions"}),"\n",(0,a.jsx)(e.h3,{id:"error-1-invalid-plan-format",children:'Error 1: "Invalid plan format"'}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:"# Solution: Validate plan structure\r\ndef validate_plan(plan):\r\n    if not isinstance(plan, list):\r\n        return False\r\n    for action in plan:\r\n        if 'action' not in action:\r\n            return False\r\n    return True\n"})}),"\n",(0,a.jsx)(e.h3,{id:"error-2-action-execution-failed",children:'Error 2: "Action execution failed"'}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:"# Solution: Implement retry logic\r\ndef execute_with_retry(action, max_retries=3):\r\n    for i in range(max_retries):\r\n        if execute_action(action):\r\n            return True\r\n        time.sleep(1)\r\n    return False\n"})}),"\n",(0,a.jsx)(e.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,a.jsx)(e.p,{children:"Continue learning:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"/physical-ai-textbook/docs/module-04-vla/multimodal",children:"Chapter 5: Multimodal Systems"})," - Complete VLA pipeline"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"/physical-ai-textbook/docs/module-04-vla/capstone-project",children:"Chapter 6: Capstone Project"})," - Build autonomous butler"]}),"\n"]})]})}function m(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(p,{...n})}):p(n)}},8453:(n,e,r)=>{r.d(e,{R:()=>s,x:()=>o});var t=r(6540);const a={},i=t.createContext(a);function s(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:s(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);